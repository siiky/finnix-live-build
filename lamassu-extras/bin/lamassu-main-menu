#!/usr/bin/env sh

lamassu_bin_dir="$(dirname "$0")"

IMAGE="${lamassu_bin_dir}/../image.img.gz"
IMAGE_ENV="${lamassu_bin_dir}/../image.env"

LMX_RELEASE_NUMBER="$(grep '^LMX_RELEASE_NUMBER=' "${IMAGE_ENV}" | cut -d= -f2)"
LMX_MACHINE_VERSION="$(grep '^LMX_MACHINE_VERSION=' "${IMAGE_ENV}" | cut -d= -f2)"

TUI_OK=0

tui() {
	whiptail "$@" 3>&2 2>&1 1>&3 3>&-
}

tui_main_menu() {
	local menumsgextra=''
	if [ "${LMX_RELEASE_NUMBER}" != '' ]; then menumsgextra="${menumsgextra}\nl-m-x release number: ${LMX_RELEASE_NUMBER}"; fi
	if [ "${LMX_MACHINE_VERSION}" != '' ]; then menumsgextra="${menumsgextra}\nLamassu machine version: ${LMX_MACHINE_VERSION}"; fi
	tui --title 'Lamassu installer main menu' \
		--menu 'What do you wish to do?  If you wish to install the Lamassu software on a machine, but are unsure on how to proceed, choose the "guided installer".${menumsgextra}' 0 0 0 \
		guided 'Launch the Lamassu guided installer' \
		shell 'Start a Bash shell' \
		shutdown 'Shut the machine down' \
		reboot 'Reboot the machine'
}

do_guided() {
	"${lamassu_bin_dir}"/flash-image.sh guided "${IMAGE}"
}

do_shell() {
	/bin/bash --norc --noprofile
}

do_shutdown() {
	shutdown -h now
}

do_reboot() {
	reboot
}

while true; do
	action="$(tui_main_menu)"
	case $? in
		"$TUI_OK") "do_${action}";;
		*);;
	esac
done
